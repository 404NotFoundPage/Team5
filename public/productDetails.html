<!-- create by lixin on 2018/3/29-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet/less" href="less/productDetails.less"/>
</head>
<body>
<!--头部-->
<%-include head.html %>
<!-- 内容-->
<div id="container">
    <section>
        <!--图片展示-->
        <div id="showImg">
            <div>
                <img src='<%=imgurllist[0]%>' alt=""/>
                <div id="left">&#xf0343;</div>
                <div id="right">&#xf0344;</div>
            </div>
            <div>
                <ul>
                    <li><img src="<%=imgurllist[0]%>" id="img1"/></li>
                    <li><img src="<%=imgurllist[1]%>" id="img2"/></li>
                    <li><img src="<%=imgurllist[2]%>" id="img3"/></li>
                    <li><img src="<%=imgurllist[3]%>" id="img4"/></li>
                </ul>
            </div>
        </div>
        <!--产品信息展示-->
        <div id="productInfo" uid="<%=pro_id %>">
            <h2><%=name %></h2>
            <p id="describe"><%=info %>
            </p>
            <h3>RMB:<label><%=price %></label></h3>
            <p id="salesNum">销量：<label><%=salesNum %></label>件</p>
            <h4>数量</h4>
            <div id="numberControl">
                <input type="button" id="reduce" value="-">
                <input  id="showNumber" type="text" value="1"/>
                <input type="button" id="add" value="+">
            </div>
            <div id="operation">
                <button id="goumai">立即购买</button>
                <button id="addcart"><span></span>加入购物车</button>
            </div>
        </div>
    </section>
    <section>
        <div id="choose">
            <div id="productD">产品详情</div>
            <div id="comment">商品评论</div>
        </div>
        <!-- 产品详情-->
        <div id="Details">
            <div id="DetailShow">
                <div class="dashedDiv"><img src="<%=imgurllist[4]%>" id="img5"/></div>
                <div class="vertical">
                    <h2><img src="images/teaProduct/circle.png" /><%=titlelist[0] %></h2>
                    <p><%=descriptlist[0] %></p>
                </div>
            </div>
            <!-- 商品参数-->
            <div id="DetailNum">
                <div>
                    <div>
                        <p>PRADUCT PARAMETERS</p>
                        <h3>
                            产<label>|</label>品<label>|</label>
                            <label class="red">参</label><label>|</label><label class="red">数</label>
                        </h3>
                    </div>
                    <div>
                        <h3> <%=titlelist[1] %></h3>
                        <p>
                            <%=descriptlist[1] %>
                        </p>
                    </div>
                </div>
                <img src="<%=imgurllist[5]%>" id="img6" />
                <div>
                    <h4>品名： <p><%=name %></p> 品牌：<p>素瓷</p></h4>
                    <h4>材质： <p><%=material %></p>  规格：<p><%=size %></p></h4>
                    <h4>养护：<p><%=detail %></p></h4>
                </div>
            </div>
            <div id="detailDisplay">
                <div>产品细节展示</div>
                <div>
                    <div class="dashedDiv"><img src="<%=imgurllist[6]%>" id="img7" class="image1"/></div>
                    <div class="dashedDiv"><img src="<%=imgurllist[7]%>" id="img8" class="image2"/></div>
                    <div>
                        <h2>
                            <img src="images/teaProduct/circle.png" /><%=titlelist[2] %>
                        </h2>
                        <p><%=descriptlist[2] %></p>
                    </div>
                </div>
                <div>
                    <div>
                        <p><%=descriptlist[3] %></p>
                        <h2><img src="images/teaProduct/circle.png" /><%=titlelist[3] %></h2>
                    </div>
                    <div>
                        <div class="dashedDiv"><img src="<%=imgurllist[8]%>" id="img9"/></div>
                        <div class="dashedDiv"><img src="<%=imgurllist[9]%>" id="img10"/></div>
                    </div>
                </div>
                <div>
                    <div>
                        <div class="dashedDiv"><img src="<%=imgurllist[10]%>" id="img11" class="image1"/></div>
                        <div class="dashedDiv"><img src="<%=imgurllist[11]%>" id="img12" class="image2"/></div>
                    </div>
                    <div>
                        <h2>
                            <img src="images/teaProduct/circle.png" /><%=titlelist[4] %>
                        </h2>
                        <p><%=descriptlist[4] %></p>
                    </div>
                </div>
            </div>
            <div id="package">
                <div>
                    <p>EXQUISITE PACKAGING</p>
                    <h3>
                        精<label>|</label>美<label>|</label>
                        <label class="red">包</label><label>|</label><label class="red">装</label>
                    </h3>
                </div>
                <img src="images/package.jpg"/>
            </div>
        </div>
        <!-- 商品评论-->
        <div id="productComment">
            <div id="commentNum">
                共有<label class="sumcomment"></label>条评论
            </div>
            <ul id="commentli"></ul>
            <!-- 分页-->
            <div id="paging">
                <select name="" id="size">
                    <option value="">15</option>
                    <option value="">10</option>
                </select>
                <button id="num">共<label class="sumcomment"></label>条/<label id="pagesize"></label>条</button>
                <button id="firstpage">首页</button>
                <button id="prepage">上一页</button>
                <!-- 页码-->
                <div id="pageNum"></div>
                <button id="nextpage">下页</button>
                <button id="lastpage">末页</button>
            </div>
        </div>
    </section>
</div>
<!--尾部-->
<%-include footer.html %>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/ajax.js"></script>
<script src="js/productDetails.js"></script>
<script src="js/less.min.js" type="text/javascript"></script>
<script type="text/javascript">
    //立即购买
    $("#goumai").click(function () {
        let pro_id = $("#productInfo").attr("uid");
        let total = $("#showNumber").val();
            window.location.href="OrderSubmission.html?pro_id="+pro_id+"&total="+total

    })


    var pro_id=$('#productInfo').attr('uid');     //当前商品的编号
    var totalCount;  //总评论数
    var pagesize=15; //每一页的评论数
    var totalPage;    //总页数
    var currentPage=1;  //当前页
    $("#comment").on('click',function(){
        getTotalCount();
        commentList();
        reply();
    });
    //获取总的数量
    function getTotalCount(){
        ajaxFn({
            "param": "pro_id=" + pro_id + "&pagesize=" + pagesize,
            "callback": function (xmlHttp) {
                var obj= JSON.parse(xmlHttp.responseText);
               totalCount=obj.totalcount;
                $(".sumcomment").text(totalCount);
                $("#pagesize").text(pagesize);      //每一页显示的数据量
                page();
            },
            "method": "post",
            "url": "/gettotalcount.do"
        })
    }
    function commentList(){
        ajaxFn({
            "param":"pro_id="+pro_id+"&pagesize="+pagesize+"&currentpage="+currentPage,
            "callback":function(xmlHttp){
                var comment=document.getElementById("commentli");
                comment.innerHTML="";
                var obj=JSON.parse(xmlHttp.responseText);
                var commentid=obj.commentId;
                var usernamelist=obj.usernameList;
                var  commenttextlist=obj.commenttextList;
                var commenttimelist=obj.commenttimeList;
                var userpiclist=obj.userpicList;
                for(var i=0;i<usernamelist.length;i++){
                    var time=commenttimelist[i].replace('T',' ').replace('Z','').replace('.000','');
                    comment.innerHTML+="<li id='"+commentid[i]+"'><img src='"+userpiclist[i]+"'/><div class='comm'><h4>"+usernamelist[i]+"</h4><p>"+commenttextlist[i]+"</p></div>" +
                    "<div class='commtime'>"+time+"</div></li>";
                }
            },
            "method":"post",
            "url":"/comment.do"
        })
    }

    //回复
    function reply(){
        ajaxFn({
            "param":"pro_id="+pro_id,
            "callback":function(xmlHttp){
                var obj=JSON.parse(xmlHttp.responseText);
                var commentid=obj.comId;
                var reply=obj.reply;
                for(var i=0;i<commentid.length;i++){
                    $("#"+commentid[i]).css({"height":"160px"})
                    $("#"+commentid[i]).append("<div class='reply'><h4>商家回复：</h4><p>"+reply[i]+"</p></div>")
                }
            },
            "method":"post",
            "url":"/reply.do"
        })
    }
//    获取总的页数，并且将页码按钮显示
    function page(){
        var init=document.getElementById('pageNum');
        init.innerHTML="";
        if(totalCount%pagesize==0){
            totalPage=totalCount/pagesize;     //总页数
        }else{
            totalPage=Math.ceil(totalCount/pagesize);
        }
        for(var j=1;j<=totalPage;j++){
            init.innerHTML+="<button class='btn'>"+j+"</button>"
        }
    }
    $("#size").change(function(){
        var sizenum=$("#size option:selected").text(); //拿到选中项的文本
        pagesize=sizenum;
        currentPage=1;
        $("#pagesize").text(pagesize);
        page();
        commentList();
    });
//点击页码按钮，让自身颜色改变，其他按钮初始化，并且获取当前页
    $("#pageNum").on('click',".btn",function(){
        var pagebtnlist=$(".btn");
        for(var i=0;i<pagebtnlist.length;i++){
            $(pagebtnlist[i]).css({"background-color":"white","color":"black"});
        }
        $(this).css({"background-color":"#273b5e","color":"white"});
        currentPage=$(this).text();
        commentList();
    });
    //下一页
    $('#nextpage').click(function(){
        if(currentPage<totalPage){
            currentPage++;
            commentList()
        }
    });
    //最后一页
    $('#lastpage').click(function(){
        currentPage=totalPage;
        commentList();
    });
    //上一页
    $("#prepage").click(function(){
        if(currentPage>1){
            currentPage--;
            commentList();
        }
    });
    //第一页
    $("#firstpage").click(function(){
        currentPage=1;
        commentList();
    });

    //加入购物车
    $('#addcart').click(function(){
        var price=$('#productInfo h3>label').text();
        var num=$('#showNumber').attr('value');
        var pro_id=$('#productInfo').attr('uid');
        ajaxFn({
            "param":"pro_id="+parseInt(pro_id)+"&num="+num,
            "callback":function(xmlHttp){
                var obj=xmlHttp.responseText;
                if(obj=='ok'){
//                    location.href=''
                }else if(obj=='fail'){

                }else if(obj=='notLogin'){
                    location.href="login.html";
                }
            },
            "method":"get",
            "url":"/addcart.do"
        })
    })
</script>
</body>
</html>